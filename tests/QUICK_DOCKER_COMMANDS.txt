# Quick Copy-Paste Commands for Docker Stress Tests

## Build Image
docker build -t vpn-alpine -f tests/Dockerfile .

## Start VSwitch + 2 VPorts (Basic Test)
docker run -d --name vswitch --cap-add=NET_ADMIN --device=/dev/net/tun vpn-alpine /app/build/vswitch 8080
docker run -d --name vport1 --cap-add=NET_ADMIN --device=/dev/net/tun --network container:vswitch vpn-alpine /app/build/vport 127.0.0.1 8080 tap0
docker run -d --name vport2 --cap-add=NET_ADMIN --device=/dev/net/tun --network container:vswitch vpn-alpine /app/build/vport 127.0.0.1 8080 tap1
docker exec vport1 ip addr add 10.1.1.101/24 dev tap0 && docker exec vport1 ip link set tap0 up
docker exec vport2 ip addr add 10.1.1.102/24 dev tap1 && docker exec vport2 ip link set tap1 up

## Test Connectivity
docker exec vport1 ping -c 10 10.1.1.102

## Watch Logs
docker logs -f vswitch

## Cleanup
docker stop vswitch vport1 vport2 && docker rm vswitch vport1 vport2

################################################################################

## Scale Test: 5 VPorts
docker run -d --name vswitch-scale --cap-add=NET_ADMIN --device=/dev/net/tun vpn-alpine /app/build/vswitch 8080

for i in {1..5}; do
  docker run -d --name vport$i --cap-add=NET_ADMIN --device=/dev/net/tun --network container:vswitch-scale vpn-alpine /app/build/vport 127.0.0.1 8080 tap$i
  docker exec vport$i ip addr add 10.1.1.$((100 + i))/24 dev tap$i && docker exec vport$i ip link set tap$i up
done

## Test All Pairs
for src in {1..5}; do for dst in {1..5}; do [ $src -ne $dst ] && docker exec vport$src ping -c 1 -W 1 10.1.1.$((100 + dst)); done; done

## Cleanup
docker stop vswitch-scale vport{1..5} && docker rm vswitch-scale vport{1..5}

################################################################################

## Throughput Test
docker run -d --name vswitch-tp --cap-add=NET_ADMIN --device=/dev/net/tun vpn-alpine /app/build/vswitch 8080
docker run -d --name vport-tp1 --cap-add=NET_ADMIN --device=/dev/net/tun --network container:vswitch-tp vpn-alpine /app/build/vport 127.0.0.1 8080 tap0
docker run -d --name vport-tp2 --cap-add=NET_ADMIN --device=/dev/net/tun --network container:vswitch-tp vpn-alpine /app/build/vport 127.0.0.1 8080 tap1
docker exec vport-tp1 ip addr add 10.1.1.101/24 dev tap0 && docker exec vport-tp1 ip link set tap0 up
docker exec vport-tp2 ip addr add 10.1.1.102/24 dev tap1 && docker exec vport-tp2 ip link set tap1 up
docker exec vport-tp1 ping -i 0.01 -c 1000 10.1.1.102

## Cleanup
docker stop vswitch-tp vport-tp1 vport-tp2 && docker rm vswitch-tp vport-tp1 vport-tp2

################################################################################

## Monitor Resources
docker stats --no-stream
docker logs -f vswitch

################################################################################

## Complete Cleanup (Remove ALL test containers)
docker stop $(docker ps -q --filter "name=vswitch\|vport") 2>/dev/null
docker rm $(docker ps -aq --filter "name=vswitch\|vport") 2>/dev/null

################################################################################

## Industry Standard: iPerf3 Throughput Test
# Build and start system
docker build -t vpn-alpine -f tests/Dockerfile .
docker run -d --name vswitch --cap-add=NET_ADMIN --device=/dev/net/tun vpn-alpine /app/build/vswitch 8080
docker run -d --name vport1 --cap-add=NET_ADMIN --device=/dev/net/tun --network container:vswitch vpn-alpine /app/build/vport 127.0.0.1 8080 tap0
docker run -d --name vport2 --cap-add=NET_ADMIN --device=/dev/net/tun --network container:vswitch vpn-alpine /app/build/vport 127.0.0.1 8080 tap1
docker exec vport1 ip addr add 10.1.1.101/24 dev tap0 && docker exec vport1 ip link set tap0 up
docker exec vport2 ip addr add 10.1.1.102/24 dev tap1 && docker exec vport2 ip link set tap1 up

# Install iperf3 and test
docker exec vport1 apk add iperf3 && docker exec vport2 apk add iperf3
docker exec vport2 iperf3 -s &
sleep 2
docker exec vport1 iperf3 -c 10.1.1.102 -t 30

## UDP Throughput Test
docker exec vport1 iperf3 -c 10.1.1.102 -u -b 100M -t 60

## Parallel Streams Test (4 streams)
docker exec vport1 iperf3 -c 10.1.1.102 -P 4 -t 30

## Cleanup
docker stop vswitch vport1 vport2 && docker rm vswitch vport1 vport2

################################################################################

## Run Industry Standard Test Suite
./tests/stress_industry_standard.sh

